#!/bin/bash
# Prevent committing secrets
echo "âœ… Pre-commit hook ran"
echo "ğŸ•µï¸â€â™€ï¸ Running Gitleaks detect (pre-commit)..."

if ! gitleaks detect --source="$(pwd)" --config=".gitleaks.toml" --exit-code 1; then
  echo "ğŸ›‘ Gitleaks detected secrets. Aborting commit."
  exit 1
fi
echo "âœ… No secrets found. Proceeding with commit."

# Check for empty files in staged changes
echo "ğŸ“‚ Checking for empty files in staged changes..."

# Files we allow to be empty (placeholders, etc.)
ALLOW_EMPTY_REGEX='(^|/)\.gitkeep$|(^|/)\.keep$'

# Get staged added/modified files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=AM)

EMPTY_FILES=""
while IFS= read -r file; do
  [ -z "$file" ] && continue
# Skip allowed placeholders
  if echo "$file" | grep -Eq "$ALLOW_EMPTY_REGEX"; then
    continue
  fi
  if [ -f "$file" ] && [ ! -s "$file" ]; then
    EMPTY_FILES+="$file"$'\n'
  fi
done <<< "$STAGED_FILES"

if [ -n "$EMPTY_FILES" ]; then
  echo "ğŸ›‘ Empty files detected in staged changes:"
  printf "%s" "$EMPTY_FILES"
  echo -e "\nPlease remove them or add content before committing."
  exit 1
fi

echo "âœ… No empty files found. Proceeding with commit."
name: 🔐 Gitleaks Secret Scan

on:
  pull_request:
    branches: [development]

jobs:
  gitleaks:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 # Needed to scan full commit history

      - name: 🧰 Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: 📦 Install latest Gitleaks
        run: |
          GITLEAKS_VERSION=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/gitleaks/gitleaks/releases/latest | jq -r '.tag_name')

          if [ -z "$GITLEAKS_VERSION" ] || [ "$GITLEAKS_VERSION" == "null" ]; then
            echo "❌ Failed to fetch latest Gitleaks version"
            exit 1
          fi

          echo "Installing Gitleaks $GITLEAKS_VERSION"
          curl -sSL -o gitleaks.tar.gz \
            "https://github.com/gitleaks/gitleaks/releases/download/${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION#v}_linux_x64.tar.gz"

          tar -xzf gitleaks.tar.gz gitleaks
          chmod +x gitleaks
          sudo mv gitleaks /usr/local/bin/
          gitleaks version

      - name: 🧠 Set report filename based on PR or branch
        id: meta
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            NAME="gitleaks-PR-${{ github.event.pull_request.number }}.json"
          else
            BRANCH="${{ github.ref_name }}"
            SAFE_BRANCH=$(echo "$BRANCH" | tr '/' '-')
            NAME="gitleaks-${SAFE_BRANCH}.json"
          fi
          echo "report_name=$NAME" >> "$GITHUB_OUTPUT"

      - name: 🕵️ Run Gitleaks with local config
        run: |
          gitleaks detect \
            --source="${{ github.workspace }}" \
            --config="${{ github.workspace }}/.gitleaks.toml" \
            --report-format=json \
            --report-path="${{ steps.meta.outputs.report_name }}"

      - name: ✅ Gitleaks completed successfully
        if: success()
        run: echo "✅ No secrets found by Gitleaks!"

      - name: 🛑 Fail if secrets are found
        if: failure()
        run: |
          echo "❌ Gitleaks detected one or more potential secrets!"
          exit 1

      - name: 📤 Upload Gitleaks Report Artifact (14-day retention)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.meta.outputs.report_name }}
          path: ${{ steps.meta.outputs.report_name }}
          retention-days: 14

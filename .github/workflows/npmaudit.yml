# .github/workflows/npm-audit-fix.yml
name: "NPM Audit Fix with Change Tracking"

on:
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * 0' # Weekly Sunday at 4am

jobs:
  audit-fix:
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ›  Run npm audit fix
        run: npm audit fix --force

      - name: ğŸ“Š Show git diff
        run: |
          echo "ğŸ“¦ Changes in package-lock.json:"
          git diff package-lock.json || echo "No changes"
          echo "ğŸ“¦ Changes in package.json:"
          git diff package.json || echo "No changes"

      - name: âœ… Run Tests
        run: npm test

      - name: ğŸš€ Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: run npm audit fix --force"
          title: "chore: audit fix auto-update"
          body: |
            This PR was automatically created by GitHub Actions.

            **Command:** `npm audit fix --force`

            Below are the changes made by the command:

            ```diff
            ${{ steps.diff.outputs.lockfile_diff }}
            ```
          branch: audit-fix
          labels: audit, dependencies
